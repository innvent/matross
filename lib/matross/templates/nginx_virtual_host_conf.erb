proxy_cache_path    /var/cache/www levels=1:2 keys_zone=correios-cache:8m max_size=1000m inactive=600m;
proxy_temp_path     /var/cache/www/tmp;

upstream <%= application %> {
  server <%= "unix:#{shared_path}/sockets/unicorn.sock fail_timeout=0" %>;
}

server {
    listen 80 default;
    listen 443 ssl;
    client_max_body_size 4G;
    server_name <%= server_name %>;
    keepalive_timeout 5;
    send_timeout 240;
    proxy_read_timeout 240;
    proxy_send_timeout 240;
    gzip_static on;
    root <%= "#{deploy_to}/current/public" %>;
    try_files $uri/index.html $uri.html $uri @<%= application %>;

    location @<%= application %> {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://<%= application %>;
        proxy_redirect off;
    }

    if (-f $document_root/system/maintenance.html) {
        return 503;
    }

    error_page 500 502 504 /500.html;
    location = /500.html {
        root <%= "#{deploy_to}/current/public" %>;
    }

    error_page 503 @maintenance;
    location @maintenance {
        rewrite  ^(.*)$  /system/maintenance.html break;
    }

    ssl_certificate /etc/nginx/ssl/<%= server_name.gsub('.', '_') %>.pem;
    ssl_certificate_key /etc/nginx/ssl/<%= server_name.gsub('.', '_') %>.key;
}

server {
    listen 8080;

    location /cep/ {
        proxy_pass http://api.postmon.com.br;
        proxy_cache correios-cache;
        proxy_cache_valid  200 302  1y;
        proxy_cache_valid  404      1m;
    }

    location /calculador/ {
        proxy_pass http://ws.correios.com.br;
        proxy_cache correios-cache;
        proxy_cache_valid  200 302  1d;
        proxy_cache_valid  404      1m;

        proxy_ignore_headers Cache-Control Expires Set-Cookie;
    }
}
